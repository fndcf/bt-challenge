# ğŸ”§ Middlewares - DocumentaÃ§Ã£o

## ğŸ“‹ VisÃ£o Geral

Os middlewares sÃ£o funÃ§Ãµes que tÃªm acesso aos objetos de requisiÃ§Ã£o (`req`), resposta (`res`) e Ã  prÃ³xima funÃ§Ã£o middleware (`next`).

## ğŸ›¡ï¸ Middlewares de SeguranÃ§a

### 1. **Helmet**

Adiciona headers de seguranÃ§a HTTP.

### 2. **CORS**

Controla quais origens podem acessar a API.

### 3. **Rate Limiting**

Limita o nÃºmero de requisiÃ§Ãµes por IP/usuÃ¡rio.

**Uso:**

```typescript
import {
  generalLimiter,
  strictLimiter,
  authLimiter,
} from "../middlewares/rateLimiter";

// Aplicar a todas as rotas
app.use("/api", generalLimiter);

// Aplicar a rotas especÃ­ficas
router.post("/login", authLimiter, handler);
router.post("/gerar-chaves", strictLimiter, handler);
```

**Limiters disponÃ­veis:**

- `generalLimiter`: 100 req/15min (uso geral)
- `strictLimiter`: 5 req/hora (operaÃ§Ãµes crÃ­ticas)
- `createLimiter`: 20 req/hora (criaÃ§Ãµes)
- `authLimiter`: 5 req/15min (autenticaÃ§Ã£o)

---

## ğŸ” Middlewares de AutenticaÃ§Ã£o

### 1. **authenticate**

Verifica token JWT do Firebase e adiciona dados do usuÃ¡rio ao `req.user`.

**Uso:**

```typescript
import { authenticate } from "../middlewares/auth";

router.get("/protegido", authenticate, handler);
```

### 2. **checkArenaAccess**

Verifica se o usuÃ¡rio tem acesso Ã  arena especificada.

**Uso:**

```typescript
import { authenticate, checkArenaAccess } from "../middlewares/auth";

router.post(
  "/arena/:arenaId/jogador",
  authenticate,
  checkArenaAccess("arenaId"),
  handler
);
```

### 3. **requireSuperAdmin**

Apenas super admins podem acessar.

**Uso:**

```typescript
import { authenticate, requireSuperAdmin } from "../middlewares/auth";

router.delete("/arena/:arenaId", authenticate, requireSuperAdmin, handler);
```

### 4. **optionalAuth**

AutenticaÃ§Ã£o opcional - adiciona dados se o token existir.

**Uso:**

```typescript
import { optionalAuth } from "../middlewares/auth";

router.get("/publico", optionalAuth, handler);
```

---

## âœ… Middlewares de ValidaÃ§Ã£o

### 1. **validate**

Processa resultados da validaÃ§Ã£o do express-validator.

**Uso:**

```typescript
import { body } from "express-validator";
import { validate } from "../middlewares/validation";

router.post(
  "/jogador",
  [
    body("nome").notEmpty().withMessage("Nome Ã© obrigatÃ³rio"),
    body("email").isEmail().withMessage("Email invÃ¡lido"),
  ],
  validate,
  handler
);
```

### 2. **runValidations**

Executa validaÃ§Ãµes em sequÃªncia.

**Uso:**

```typescript
import { body } from "express-validator";
import { runValidations } from "../middlewares/validation";

const validations = [body("nome").notEmpty(), body("email").isEmail()];

router.post("/jogador", runValidations(validations), handler);
```

### 3. **ValidaÃ§Ãµes Customizadas**

```typescript
import {
  isEvenNumber,
  meetsMinimumPlayers,
  isValidSlug,
  isInEnum,
} from "../middlewares/validation";

// Validar nÃºmero par
body("numJogadores").custom(isEvenNumber);

// Validar mÃ­nimo de jogadores
body("numJogadores").custom(meetsMinimumPlayers);

// Validar slug
body("slug").custom(isValidSlug);

// Validar enum
body("nivel").custom(isInEnum(NIVEIS_JOGADOR));
```

### 4. **sanitizeRequest**

Limpa espaÃ§os em branco de strings em body, query e params.

---

## ğŸš¨ Middlewares de Erro

### 1. **errorHandler**

Tratamento global de erros (sempre o Ãºltimo middleware).

**Uso automÃ¡tico** - jÃ¡ configurado no `index.ts`

### 2. **asyncHandler**

Captura erros de funÃ§Ãµes assÃ­ncronas automaticamente.

**Uso:**

```typescript
import { asyncHandler } from "../middlewares/errorHandler";

router.get(
  "/jogadores",
  asyncHandler(async (req, res) => {
    const jogadores = await buscarJogadores();
    res.json(jogadores);
  })
);
```

### 3. **notFoundHandler**

Responde com 404 para rotas nÃ£o encontradas.

**Uso automÃ¡tico** - jÃ¡ configurado no `index.ts`

---

## ğŸ“ Middlewares de Logging

### 1. **requestLogger**

Loga todas as requisiÃ§Ãµes (apenas em dev).

**Formato:**

```
[2024-01-10T10:30:00.000Z] GET     /api/jogadores                           200     45ms - ::1
```

### 2. **errorLogger**

Loga erros detalhadamente (apenas em dev).

### 3. **slowRequestLogger**

Alerta sobre requisiÃ§Ãµes lentas (> 1 segundo).

---

## ğŸ¯ Ordem dos Middlewares

A ordem Ã© **MUITO IMPORTANTE**! Ordem correta no `index.ts`:

```typescript
// 1. SeguranÃ§a
app.use(helmet());
app.use(cors());

// 2. Parsers
app.use(express.json());
app.use(express.urlencoded());

// 3. Logging (dev)
app.use(requestLogger);

// 4. SanitizaÃ§Ã£o
app.use(sanitizeRequest);

// 5. Rate Limiting
app.use("/api", generalLimiter);

// 6. Rotas
app.use("/api", apiRoutes);

// 7. Not Found
app.use(notFoundHandler);

// 8. Error Logger (dev)
app.use(errorLogger);

// 9. Error Handler (sempre por Ãºltimo!)
app.use(errorHandler);
```

---

## ğŸ’¡ Exemplo Completo de Rota

```typescript
import { Router } from "express";
import { body, param } from "express-validator";
import { asyncHandler } from "../middlewares/errorHandler";
import { authenticate, checkArenaAccess } from "../middlewares/auth";
import { validate } from "../middlewares/validation";
import { createLimiter } from "../middlewares/rateLimiter";
import { ResponseHelper } from "../utils/responseHelper";
import { NotFoundError } from "../utils/errors";

const router = Router();

router.post(
  "/arena/:arenaId/jogador",
  createLimiter, // 1. Rate limiting
  authenticate, // 2. AutenticaÃ§Ã£o
  checkArenaAccess("arenaId"), // 3. Verificar acesso Ã  arena
  [
    // 4. ValidaÃ§Ãµes
    param("arenaId").notEmpty(),
    body("nome").notEmpty().trim(),
    body("email").isEmail().normalizeEmail(),
    body("nivel").isIn(["Iniciante", "IntermediÃ¡rio", "AvanÃ§ado"]),
  ],
  validate, // 5. Processar validaÃ§Ãµes
  asyncHandler(async (req, res) => {
    // 6. Handler com tratamento de erro
    const { arenaId } = req.params;
    const jogadorData = req.body;

    // LÃ³gica de negÃ³cio
    const jogador = await criarJogador(arenaId, jogadorData);

    if (!jogador) {
      throw new NotFoundError("NÃ£o foi possÃ­vel criar jogador");
    }

    // Resposta padronizada
    return ResponseHelper.created(res, jogador, "Jogador criado com sucesso");
  })
);

export default router;
```

---

## ğŸ”’ Boas PrÃ¡ticas

1. **Sempre use `asyncHandler`** em rotas assÃ­ncronas
2. **Valide todos os inputs** do usuÃ¡rio
3. **Use erros customizados** (`NotFoundError`, `ValidationError`, etc)
4. **Sanitize dados** antes de processar
5. **Apply rate limiting** em operaÃ§Ãµes sensÃ­veis
6. **Autentique e autorize** adequadamente
7. **Use `ResponseHelper`** para respostas padronizadas
8. **Log erros** adequadamente (mas nÃ£o exponha detalhes em produÃ§Ã£o)

---

## ğŸš€ PrÃ³ximos Passos

Com essa estrutura de middlewares, estamos prontos para:

- âœ… Criar rotas protegidas
- âœ… Validar dados de entrada
- âœ… Tratar erros adequadamente
- âœ… Proteger contra ataques
- âœ… Logar requisiÃ§Ãµes e erros
